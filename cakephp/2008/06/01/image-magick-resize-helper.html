<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>CakePHP ; Image Magick Resize Helper</title>
        <meta name="viewport" content="initial-scale=1.0">
        <link href='/assets/global-4f95d28fa671039d795aecbacd54a16d.css' rel='stylesheet' type='text/css' />

    </head>
    <body>
      <div class="container">
        <header>
          <h1>Jean-Philippe Doyle (j15e)</h1>
          <h2>Developer, homebrewer & more</h2>
          <nav>
            <a href="/">articles</a></h1>
            <a class="extra" target="_blank" href="http://github.com/j15e/">@github</a>
            <a class="extra" target="_blank" href="http://twitter.com/j15e/">@twitter</a>
          </nav>
        </header>

            <h2>CakePHP ; Image Magick Resize Helper</h2>
<p class="meta">01 Jun 2008</p>

<div id="post" class="hyphenate text" lang="en">
<p>*Also published on <a href="http://bakery.cakephp.org/articles/view/image-magick-convert-resizing-helper-with-cache">The Bakery</a> at CakePHP.</p>

<p>Here is my helper based on Josh Hundley <a href="http://bakery.cakephp.org/articles/view/image-resize-helper">image resize helper</a>. My helper is using ImageMagick instead of PHP GD libraries which are more tricky to use and provide less options in my opinion.</p>

<p>You may had more functions to the helper related to ImageMagick abilities. You can find more informations about the resize function and other possibilities at <a href="http://www.imagemagick.org/script/command-line-options.php#resize">ImageMagick documentation.</a></p>

<pre><code>class MagickConvertHelper extends Helper {
    var $helpers = array('Html');
    /**
     * path to cache folder
     *
     * @var string
     * @access public
     */
        var $cachePath = 'cache';
    /**
     * path to ImageMagick convert tool
     *
     * @var string
     * @access public
     */
    var $convertPath = '/usr/bin/convert';

    /**
     * Automatically resizes an image and returns formatted img tag or only url (optional)
     *
     * @param string $filePath Path to the image file, relative to the webroot/ directory.
     * @param integer $width Width of returned image
     * @param integer $height Height of returned image
     * @param boolean $tag Return html tag (default: true)
     * @param boolean $cachePath Path to cache folder (default: this-&gt;cachePath)
     * @param boolean $quality Quality of returned image (default: 100)
     * @param boolean $aspect Maintain aspect ratio (default: true)
     * @param array $options Array of HTML attributes.
     * @access public
     */
    function resize($filePath, $width, $height, $tag=true, $cachePath=null, $quality=100, $aspect=true, $options = array()) {
        if(!$cachePath) $cachePath = $this-&gt;convertPath;
        $htmlOptions = $this-&gt;__getHtmlOptions($options);

        $fullpath = ROOT.DS.APP_DIR.DS.WEBROOT_DIR.DS.$this-&gt;themeWeb;
        $url = $fullpath.$filePath;

        // Verify image exist
        if (!($size = getimagesize($url))) {
            return;
        }

        // Relative file (for return use)
        $relfile = $this-&gt;webroot.$this-&gt;themeWeb.$cachePath.'/'.$width.'x'.$height.'_'.basename($filePath);
        // Location on server (for resize use)
        $cachefile = $fullpath.$cachePath.DS.$width.'x'.$height.'_'.basename($filePath);


        // Verify if file is cached
        $cached = false;
        if (file_exists($cachefile)) {
            if (@filemtime($cachefile) &gt; @filemtime($url)) {
                $cached = true;
            }
        }

        // Verify resize neccessity
        $resize = false;
        if (!$cached) {
            $resize = ($size[0] &gt; $width || $size[1] &gt; $height) || ($size[0] &lt; $width || $size[1] &lt; $height);
        }

        if ($resize) {
            if($aspect) {
                // Use Image Magick build-in keep ratio option
                $resizeOption = '\'&gt;\'';
            } else {
                $resizeOption = '';
            }
            exec($this-&gt;convertPath.' -resize '.$width.'x'.$height.$resizeOption.' -quality '.$quality.' '.$url.' '.$cachefile);
        }

        if($tag) {
            return $this-&gt;Html-&gt;image($relfile, $htmlOptions);
        } else {
            return $relfile;
        }
    }
}
</code></pre>

</div>


        <footer>
          <a target="_blank" href="https://github.com/j15e/j15e.github.io">View source (⌥⌘U)</a>
        </footer>
      </div>
    </body>
</html>
